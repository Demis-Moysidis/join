<section>
    <!-- <header>
        <h1>{{ editMode ? 'Edit Task' : 'Add Task' }}</h1>
        <button class="clear" (click)="onExit()">
            {{ editMode ? 'Cancel Edit' : 'Clear' }}
            <img src="/assets/icons/button_x_check/button_x.png">
        </button>
    </header> -->

    <header>
        <h1>Add Task</h1>
        @if (editMode) {
        <button class="clear" (click)="onExit()">EDIT CANCEL<img
                src="/assets/icons/button_x_check/button_x.png"></button>}
        @else {
        <span></span>
        }
    </header>

    <form #taskForm="ngForm" (ngSubmit)="onSubmitOrSave(taskForm)" class="task-form">
        <main>
            <div class="left_box">
                <div>
                    <label for="title">Title <span>*</span></label>
                    <input type="text" id="title" name="title" [(ngModel)]="targetTask.title" #titleInput="ngModel"
                        placeholder="Title" minlength="2" required />
                </div>
                <div class="error">
                    @if (titleInput.invalid && (titleInput.dirty || titleInput.touched || taskForm.submitted)) {
                    <span>
                        @if (titleInput.errors?.['required']) {
                        Enter Name
                        } @else if (titleInput.errors?.['minlength']) {
                        min 2 characters
                        }
                    </span>
                    }
                </div>

                <div>
                    <label for="description">Description</label>
                    <textarea id="description" name="description" [(ngModel)]="targetTask.description"
                        placeholder="Description"></textarea>
                </div>
                <div>
                    <label for="date">Due date <span>*</span></label>
                    <input type="date" id="date" name="due_date" [(ngModel)]="targetTaskDueDateString"
                        [min]="todayString" #dateInput="ngModel" required />
                </div>
                <div class="error">
                    @if (dateInput.invalid) {
                    <span>
                        @if (dateInput.errors?.['required']) {
                        enter a date
                        }
                    </span>
                    }
                </div>

            </div>

            <div class="line"></div>

            <div class="right_box">
                <div class="right_box_container">
                    <label>Priority</label>
                    <div class="priority-buttons">
                        <button type="button" [class.active_high]="targetTask.priority === 'Urgent'"
                            (click)="targetTask.priority = 'Urgent'">
                            Urgent <img src="/assets/icons/urgent.svg">
                        </button>
                        <button type="button" [class.active_medium]="targetTask.priority === 'Medium'"
                            (click)="targetTask.priority = 'Medium'">
                            Medium <img src="/assets/icons/medium.svg">
                        </button>
                        <button type="button" [class.active_low]="targetTask.priority === 'Low'"
                            (click)="targetTask.priority = 'Low'">
                            Low <img src="/assets/icons/low.svg">
                        </button>
                    </div>
                </div>

                <label>Assigned to</label>
                <ng-select class="ng_select" [items]="contactService.contactsList" bindLabel="name"
                    [(ngModel)]="targetTask.assigned_to" name="assigned_to" placeholder="Search contacts..."
                    [multiple]="true" [closeOnSelect]="false" [clearable]="false" [searchable]="true">

                    <!-- Custom option template -->
                    <ng-template ng-option-tmp let-contact="item">
                        <div class="option_row_wrapper" (click)="$event.stopPropagation()">
                            <div class="avatar" [style.background-color]="contact?.initial_avatar_color">
                                <p>{{ initials(contact.name) }}</p>
                            </div>
                            <div class="fullname">{{ contact.name }}</div>
                            <input type="checkbox" [checked]="isAssigned(contact)"
                                (click)="$event.stopPropagation(); toggleAssigned(contact)" />
                        </div>
                    </ng-template>

                    <!-- Custom value template: override default tags -->
                    <ng-template ng-label-tmp>
                        <!-- keep it empty so nothing shows inside input -->
                        <span></span>
                    </ng-template>
                </ng-select>

                <div class="selected_badges_wrapper">
                    @for (it of targetTask.assigned_to; track $index) {
                    <div class="badge_container" [style.background-color]="it?.initial_avatar_color">
                        <p>{{ initials(it.name) }}</p>
                    </div>
                    }
                </div>

                <div class="right_box_container">
                    <label for="category">Category <span>*</span></label>
                    <select id="category" name="category" [(ngModel)]="targetTask.category" #categoryInput="ngModel"
                        required>
                        <option value="Technical Task">Technical Task</option>
                        <option value="User Story">User Story</option>
                    </select>
                </div>
                <div class="error">
                    @if (categoryInput.invalid && (categoryInput.dirty || categoryInput.touched || taskForm.submitted))
                    {
                    <span>
                        {{ categoryInput.errors?.['required'] ? 'UPS Vergessen' : '' }}
                    </span>
                    }

                </div>

                <div class="subtasks right_box_container">
                    <label for="subtask">Subtasks</label>
                    <input type="text" id="subtask" [(ngModel)]="subtaskTitle" name="subtaskTitle"
                        placeholder="Subtask title" />
                    <button type="button" (click)="addSubtask()">Add</button>

                    <ul>
                        @for (subtask of targetTask.subtask; track $index) {
                        <li>
                            {{ subtask.title }}
                            <button type="button" (click)="removeSubtask($index)">x</button>
                        </li>
                        }

                    </ul>
                </div>
            </div>
        </main>

        <footer>
            <div>
                <p><span>*</span>This field is required</p>
            </div>
            <div>
                <button class="clear" (click)="onExit()">Clear<img
                        src="/assets/icons/button_x_check/button_x.png"></button>
                <button class="add_task" type="submit">Add Task<img
                        src="/assets/icons/button_x_check/button_check.png"></button>
            </div>
            <!-- <div>
                <button class="add_task" type="submit">
                    {{ editMode ? 'Save Changes' : 'Add Task' }}
                    <img src="/assets/icons/button_x_check/button_check.png">
                </button>
            </div> -->
        </footer>
    </form>
</section>